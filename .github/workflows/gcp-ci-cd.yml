name: GCP CI/CD
on:
  push:
    branches: [ main ]
    paths:
      - "Matcha/**"
      - "docker-compose.yml"
      - "Deploy/GCP/**"
      - ".github/workflows/gcp-ci-cd.yml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions: { id-token: write, contents: read }
    env:
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      REGION: asia-northeast3
      REPO: matcha
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDP }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}
      - uses: google-github-actions/setup-gcloud@v2
      - run: gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Build & Push backend
        run: |
          BACKEND_URI="${REGION}-docker.pkg.dev/${GCP_PROJECT}/${REPO}/matcha-backend:${IMAGE_TAG}"
          docker build -t $BACKEND_URI -f Matcha/backend/Dockerfile .
          docker push $BACKEND_URI
          echo "BACKEND_URI=$BACKEND_URI" >> $GITHUB_ENV

      - name: Build & Push frontend
        run: |
          FRONTEND_URI="${REGION}-docker.pkg.dev/${GCP_PROJECT}/${REPO}/matcha-frontend:${IMAGE_TAG}"
          docker build -t $FRONTEND_URI -f Matcha/frontend/Dockerfile .
          docker push $FRONTEND_URI
          echo "FRONTEND_URI=$FRONTEND_URI" >> $GITHUB_ENV

      - name: Render compose
        run: |
          sed -e "s|\${BACKEND_IMAGE}|${BACKEND_URI}|g" \
              -e "s|\${FRONTEND_IMAGE}|${FRONTEND_URI}|g" \
              docker-compose.yml > docker-compose.rendered.yml

      - name: Upload & deploy
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          source: "docker-compose.rendered.yml,Deploy/GCP/deploy.sh"
          target: "/opt/matcha"
      - uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          script: |
            chmod +x /opt/matcha/deploy.sh
            /opt/matcha/deploy.sh
