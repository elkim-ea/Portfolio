name: NCP CI/CD
on:
  push:
    branches: [ main ]
    paths:
      - "Matcha/**"
      - "docker-compose.yml"
      - "Deploy/NCP/**"
      - ".github/workflows/ncp-ci-cd.yml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ncr.apigw.ntruss.com
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Login to NCP NCR
        run: echo "${{ secrets.NCP_NCR_TOKEN }}" | docker login $REGISTRY -u ${{ secrets.NCP_NCR_USER }} --password-stdin

      - name: Build & Push backend
        run: |
          BACKEND_URI="$REGISTRY/${{ secrets.NCP_NCR_REPO }}/matcha-backend:${IMAGE_TAG}"
          docker build -t $BACKEND_URI -f Matcha/backend/Dockerfile .
          docker push $BACKEND_URI
          echo "BACKEND_URI=$BACKEND_URI" >> $GITHUB_ENV

      - name: Build & Push frontend
        run: |
          FRONTEND_URI="$REGISTRY/${{ secrets.NCP_NCR_REPO }}/matcha-frontend:${IMAGE_TAG}"
          docker build -t $FRONTEND_URI -f Matcha/frontend/Dockerfile .
          docker push $FRONTEND_URI
          echo "FRONTEND_URI=$FRONTEND_URI" >> $GITHUB_ENV

      - name: Render compose
        run: |
          sed -e "s|\${BACKEND_IMAGE}|${BACKEND_URI}|g" \
              -e "s|\${FRONTEND_IMAGE}|${FRONTEND_URI}|g" \
              docker-compose.yml > docker-compose.rendered.yml

      - name: Upload files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USER }}
          key: ${{ secrets.NCP_SSH_KEY }}
          source: "docker-compose.rendered.yml,Deploy/NCP/deploy.sh"
          target: "/opt/matcha"

      - name: Remote deploy
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USER }}
          key: ${{ secrets.NCP_SSH_KEY }}
          script: |
            chmod +x /opt/matcha/deploy.sh
            /opt/matcha/deploy.sh
