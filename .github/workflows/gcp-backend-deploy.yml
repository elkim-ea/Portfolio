# name: Deploy Backend to GKE Autopilot

# on:
#   workflow_dispatch:
#   push:
#     branches: ["main"]

# env:
#   PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
#   GAR_LOCATION: asia-northeast3
#   GAR_REPO: matcha-repo
#   IMAGE_NAME: matcha-backend
#   GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
#   GKE_LOCATION: ${{ secrets.GKE_LOCATION }}

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest

#     steps:

#     # 1) Checkout
#     - name: Checkout Code
#       uses: actions/checkout@v4

#     # 2) Google Cloud ì¸ì¦.
#     - name: Authenticate to Google Cloud
#       uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.GCP_SA_KEY }}

#     # Google Cloud CLI ì„¤ì¹˜ (ê³µì‹ Action).
#     - name: Setup gcloud
#       uses: google-github-actions/setup-gcloud@v2

#     # ğŸ”¥ 3) GKE Auth Plugin ì„¤ì¹˜ (ê°€ì¥ ì¤‘ìš”)
#     - name: Install GKE Auth Plugin
#       run: |
#         sudo apt-get update
#         sudo apt-get install -y apt-transport-https ca-certificates gnupg

#         # Google Cloud APT repo ë“±ë¡
#         echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | \
#           sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list

#         curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | \
#           sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg

#         sudo apt-get update
#         sudo apt-get install -y google-cloud-cli-gke-gcloud-auth-plugin

#     # gke-gcloud-auth-plugin ìë™ íƒìƒ‰ ë° PATH ì¶”ê°€
#     - name: Add GKE Auth Plugin to PATH
#       run: |
#         # gcloudê°€ ì„¤ì¹˜ëœ ê²½ë¡œ í™•ì¸
#         SDK_ROOT=$(gcloud info --format='value(installation.sdk_root)')
#         echo "SDK_ROOT = $SDK_ROOT"

#         # í”ŒëŸ¬ê·¸ì¸ íŒŒì¼ ìœ„ì¹˜ ì°¾ê¸°
#         PLUGIN_PATH=$(find $SDK_ROOT -name gke-gcloud-auth-plugin | head -n 1)

#         if [ -z "$PLUGIN_PATH" ]; then
#           echo "âŒ gke-gcloud-auth-plugin not found in SDK_ROOT. Searching globally..."
#           PLUGIN_PATH=$(find / -name gke-gcloud-auth-plugin 2>/dev/null | head -n 1)
#         fi

#         if [ -z "$PLUGIN_PATH" ]; then
#           echo "âŒ ERROR: gke-gcloud-auth-plugin not found anywhere!"
#           exit 1
#         fi

#         echo "âœ… Found plugin at: $PLUGIN_PATH"
#         echo "$(dirname $PLUGIN_PATH)" >> $GITHUB_PATH

#         which gke-gcloud-auth-plugin || true
    
#     # 4) í”ŒëŸ¬ê·¸ì¸ ê²½ë¡œ í™•ì¸
#     - name: Verify plugin
#       run: |
#         which gke-gcloud-auth-plugin || echo "Plugin not in PATH"
#         gke-gcloud-auth-plugin --version || echo "Plugin missing"


#     # 4) í”ŒëŸ¬ê·¸ì¸ í™œì„±í™”
#     - name: Enable GKE Auth Plugin Env
#       run: |
#         echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV
        
    

#     # 5) GKE ì—°ê²°
#     - name: Authenticate to GKE
#       run: |
#         gcloud container clusters get-credentials $GKE_CLUSTER \
#           --region $GKE_LOCATION \
#           --project $PROJECT_ID

#     # 6) Backend JAR Build
#     - name: Build Backend JAR
#       run: |
#         cd Matcha/backend
#         chmod +x ./gradlew
#         ./gradlew clean build -x test

#     # 7) Docker Build
#     - name: Build Docker Image
#       run: |
#         docker build -f ./Matcha/backend/Dockerfile \
#         -t "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$GAR_REPO/$IMAGE_NAME:latest" \
#         ./Matcha/backend

#     # 8) Artifact Registry ë¡œê·¸ì¸
#     - name: Docker login to GAR
#       run: |
#         gcloud auth print-access-token | \
#           docker login -u oauth2accesstoken --password-stdin https://$GAR_LOCATION-docker.pkg.dev

#     # 9) Push Docker Image
#     - name: Push Docker Image
#       run: |
#         docker push "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$GAR_REPO/$IMAGE_NAME:latest"

#     # gcp-backend-deploy.yml (ìˆ˜ì •ëœ 10) Deploy to GKE Autopilot ë‹¨ê³„)

#     # 10) Deploy to GKE Autopilot
#     - name: Deploy All Core Kubernetes Resources
#       run: |
#         echo "--- Deploying Core Infrastructure (DB, Secrets, ConfigMaps) ---"
        
#         # 1. ì‹œí¬ë¦¿ ì ìš© (DB ì¸ì¦ ì •ë³´)
#         # â— db-secret.yaml íŒŒì¼ëª…ì„ í™•ì¸í•˜ì—¬ ì ìš©í•©ë‹ˆë‹¤.
#         kubectl apply -f k8s/db-secret.yaml
        
#         # 2. ConfigMap ì ìš© (DB ì´ˆê¸° ìŠ¤í‚¤ë§ˆ ë° ê¶Œí•œ ì„¤ì •)
#         # â— mariadb-initdb-config.yaml íŒŒì¼ëª…ì„ í™•ì¸í•˜ì—¬ ì ìš©í•©ë‹ˆë‹¤.
#         kubectl apply -f k8s/mariadb-initdb-config.yaml
        
#         # 3. DB Deployment ë° Service ì ìš© (MariaDB)
#         # â— DB Podê°€ ìƒˆë¡œìš´ ConfigMapì„ ë¡œë“œí•˜ë„ë¡ ì¬ë°°í¬í•©ë‹ˆë‹¤.
#         kubectl apply -f k8s/mariadb-deployment.yaml
#         kubectl apply -f k8s/mariadb-service.yaml
        
#         echo "--- Deploying Backend Service ---"
        
#         # 4. Backend Deployment ë° Service ì ìš©
#         kubectl apply -f k8s/backend-deployment.yaml
#         kubectl apply -f k8s/backend-service.yaml
        
#         # 5. ê¸°íƒ€ Backend í´ëŸ¬ìŠ¤í„° IP Service ì ìš© (í•„ìš”í•˜ë‹¤ë©´)
#         kubectl apply -f k8s/matcha-backend-clusterip.yaml
