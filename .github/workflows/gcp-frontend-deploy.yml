# .github/workflows/gcp-frontend-deploy.yml
name: Deploy Frontend to GKE Autopilot

on:
  push:
    branches: ["main"]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: asia-northeast3
  GAR_REPO: matcha-repo
  IMAGE_NAME: matcha-frontend
  IMAGE_TAG: ${{ github.sha }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_LOCATION: ${{ secrets.GKE_LOCATION }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # WIF 사용 시 필수!

    steps:

      # 1) Checkout
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2) Google Cloud 인증 (WIF 사용)
      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/348820882548/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions-sa@matcha-480312.iam.gserviceaccount.com

      # 3) GKE 인증 정보 설정 (간소화)
      - name: ☸️ Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_LOCATION }}
          project_id: ${{ env.PROJECT_ID }} # 인증 정보 로드 및 kubectl 설정 완료

      # 4) Frontend Build (npm ci, npm run build)
      - name: Build Frontend
        run: |
          cd Matcha/frontend
          npm ci
          npm run build
      
      # 5) Docker Build & Tag (이전 구문 오류 수정 및 컨텍스트 명확화)
      - name: Docker Build and Tag
        run: |
          docker build -f Matcha/frontend/Dockerfile \
          --build-arg VITE_API_BASE_URL=${{ secrets.API_BASE_URL }} \
          --build-arg VITE_IMG_BASE_URL=${{ secrets.IMG_BASE_URL }} \
          -t "${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:${IMAGE_TAG}" \
          -t "${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:latest" \
          Matcha/frontend # 빌드 컨텍스트

      # 6) Artifact Registry 로그인 및 이미지 Push
      # (WIF 인증을 통해 이미 gcloud 권한을 얻었으므로 gcloud docker login 대신 공식 Action 사용 권장)
      - name: Push Docker Image to GAR
        uses: docker/login-action@v3
        with:
          registry: ${{ GAR_LOCATION }}-docker.pkg.dev
          username: _json_key
          password: ${{ steps.auth.outputs.access_token }} # WIF 토큰 사용
      - name: Push Images
        run: |
          docker push "${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:${IMAGE_TAG}"
          docker push "${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:latest"

      # 7) Kubernetes 배포
      - name: Apply K8s manifest
        run: |
          kubectl apply -f k8s/frontend-deployment.yaml
          kubectl apply -f k8s/frontend-service.yaml
          
      # 8) 롤링 업데이트 강제 시작 (새 이미지 참조)
      - name: Restart frontend deployment
        run: kubectl rollout restart deployment/matcha-frontend