name: Deploy Frontend to GKE Autopilot (SA Key Auth)

on:
  push:
    branches: ["main"]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: asia-northeast3
  GAR_REPO: matcha-repo
  IMAGE_NAME: matcha-frontend
  IMAGE_TAG: ${{ github.sha }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_LOCATION: ${{ secrets.GKE_LOCATION }}
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # SA Key ë°©ì‹ì´ë¯€ë¡œ permissions: ë¸”ë¡ì€ í•„ìš” ì—†ìŠµë‹ˆë‹¤.

    steps:

      # 1) Checkout
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      # 2) Google Cloud ì¸ì¦ (ë°±ì—”ë“œì™€ ë™ì¼í•˜ê²Œ SA Key ì‚¬ìš©)
      - name: ğŸ”‘ Authenticate to Google Cloud (SA Key)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 3) Google Cloud CLI ì„¤ì¹˜
      - name: âš™ï¸ Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # 4) GKE Auth Plugin ì„¤ì¹˜ ë° PATH ì„¤ì • (âŒ ì´ì „ ì˜¤ë¥˜ í•´ê²°)
      - name: ğŸ”¥ Install GKE Auth Plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-transport-https ca-certificates gnupg

          # Google Cloud APT repo ë“±ë¡
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | \
            sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list

          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | \
            sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg

          sudo apt-get update
          sudo apt-get install -y google-cloud-cli-gke-gcloud-auth-plugin

      # 5) gke-gcloud-auth-plugin ìë™ íƒìƒ‰ ë° PATH ì¶”ê°€
      - name: Add GKE Auth Plugin to PATH
        run: |
          SDK_ROOT=$(gcloud info --format='value(installation.sdk_root)')
          PLUGIN_PATH=$(find $SDK_ROOT -name gke-gcloud-auth-plugin | head -n 1)

          if [ -z "$PLUGIN_PATH" ]; then
            PLUGIN_PATH=$(find / -name gke-gcloud-auth-plugin 2>/dev/null | head -n 1)
          fi

          if [ -z "$PLUGIN_PATH" ]; then
            echo "âŒ ERROR: gke-gcloud-auth-plugin not found anywhere!"
            exit 1
          fi

          echo "$(dirname $PLUGIN_PATH)" >> $GITHUB_PATH

      # 6) í”ŒëŸ¬ê·¸ì¸ í™œì„±í™” í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      - name: Enable GKE Auth Plugin Env
        run: |
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV
        
      # 7) GKE ì—°ê²° (kubectl ì‚¬ìš©ì„ ìœ„í•œ ì¸ì¦ ì •ë³´ ë¡œë“œ)
      - name: Authenticate to GKE
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_LOCATION }} \
            --project ${{ env.PROJECT_ID }}

      # 8) ë°±ì—”ë“œ ì„œë¹„ìŠ¤ IP ì£¼ì†Œ ì¡°íšŒ (âœ… ë™ì  ì£¼ì… ë¡œì§)
      - name: ğŸ” Get Backend Service External IP
        run: |
          # LoadBalancerì˜ External IPë¥¼ ì¡°íšŒ
          BACKEND_IP=$(kubectl get svc matcha-backend-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -z "$BACKEND_IP" ]; then
            echo "âŒ ERROR: Backend Service IP not found (Backend deployment may be incomplete)."
            exit 1
          fi
          echo "BACKEND_IP=$BACKEND_IP" >> $GITHUB_ENV
          
      # 9) Frontend Build (npm)
      - name: Build Frontend (npm ci / run build)
        run: |
          cd Matcha/frontend
          npm ci
          npm run build
      
      # 10) Docker Build & Tag (âœ… YAML êµ¬ë¬¸ ì˜¤ë¥˜ ìˆ˜ì • ë° IP ë™ì  ì£¼ì…)
      - name: ğŸ—ï¸ Docker Build and Tag
        run: |
          API_URL="http://${{ env.BACKEND_IP }}/api"
          IMG_URL="http://${{ env.BACKEND_IP }}/uploads"
          
          docker build -f Matcha/frontend/Dockerfile \
          --build-arg VITE_API_BASE_URL=$API_URL \
          --build-arg VITE_IMG_BASE_URL=$IMG_URL \
          -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:latest" \
          Matcha/frontend # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ëª…í™•íˆ ì§€ì •

      # 11) Artifact Registry ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ Push
      - name: ğŸ”’ Docker Login and Push
        run: |
          # gcloud í† í°ì„ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸
          gcloud auth print-access-token | \
            docker login -u oauth2accesstoken --password-stdin https://${{ env.GAR_LOCATION }}-docker.pkg.dev
          
          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:latest"

      # 12) Kubernetes ë°°í¬
      - name: ğŸš¢ Deploy to GKE
        run: |
          # ìƒˆ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ë„ë¡ Deploymentì˜ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë³€ê²½ (ë¡¤ë§ ì—…ë°ì´íŠ¸ ìœ ë°œ)
          kubectl set image deployment/matcha-frontend matcha-frontend="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          kubectl apply -f k8s/frontend-service.yaml