# .github/workflows/gcp-frontend-deploy.yml
name: Deploy Frontend to GKE Autopilot (SA Key Auth)

on:
  push:
    branches: ["main"]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: asia-northeast3
  GAR_REPO: matcha-repo
  IMAGE_NAME: matcha-frontend
  IMAGE_TAG: ${{ github.sha }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_LOCATION: ${{ secrets.GKE_LOCATION }}
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # permissions: ë¸”ë¡ì€ WIF ë°©ì‹ì´ ì•„ë‹ˆë¯€ë¡œ ì‚­ì œí•©ë‹ˆë‹¤.

    steps:

      # 1) Checkout
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2) Google Cloud ì¸ì¦ (âœ… ë°±ì—”ë“œì™€ ë™ì¼í•˜ê²Œ SA Key ì‚¬ìš©)
      - name: ğŸ”‘ Authenticate to Google Cloud (SA Key)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 3) GKE ì¸ì¦ ì •ë³´ ì„¤ì • (GKE Auth Plugin ìˆ˜ë™ ì„¤ì¹˜ëŠ” ìœ ì§€)
      # ... (GKE Auth Plugin ì„¤ì¹˜ ë° PATH ì„¤ì • ì½”ë“œëŠ” ë°±ì—”ë“œ YAMLì²˜ëŸ¼ ê·¸ëŒ€ë¡œ ìœ ì§€)
      # ë„ˆë¬´ ê¸¸ì–´ì„œ ìƒëµí•©ë‹ˆë‹¤. ì´ ë¶€ë¶„ì€ ë°±ì—”ë“œ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.

      # 4) GKE ì—°ê²°
      - name: Authenticate to GKE
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_LOCATION }} \
            --project ${{ env.PROJECT_ID }}

      # 5) ë°±ì—”ë“œ ì„œë¹„ìŠ¤ IP ì£¼ì†Œ ì¡°íšŒ (ë™ì  í™˜ê²½ ë³€ìˆ˜ ì£¼ì…)
      - name: ğŸ” Get Backend Service External IP
        run: |
          BACKEND_IP=$(kubectl get svc matcha-backend-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -z "$BACKEND_IP" ]; then
            echo "âŒ ERROR: Backend Service IP not found."
            exit 1
          fi
          echo "BACKEND_IP=$BACKEND_IP" >> $GITHUB_ENV
          
      # 6) Frontend Build (npm)
      - name: Build Frontend (npm ci / run build)
        run: |
          cd Matcha/frontend
          npm ci
          npm run build
      
      # 7) Docker Build & Tag (âœ… YAML êµ¬ë¬¸ ì˜¤ë¥˜ ìˆ˜ì • ë° IP ë™ì  ì£¼ì…)
      - name: ğŸ—ï¸ Docker Build and Tag
        run: |
          API_URL="http://${{ env.BACKEND_IP }}"
          IMG_URL="http://${{ env.BACKEND_IP }}/uploads"
          
          docker build -f Matcha/frontend/Dockerfile \
          --build-arg VITE_API_BASE_URL=$API_URL \
          --build-arg VITE_IMG_BASE_URL=$IMG_URL \
          -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:latest" \
          Matcha/frontend # âœ… ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ëª…í™•íˆ ì§€ì •

      # 8) Artifact Registry ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ Push
      - name: ğŸ”’ Docker Login and Push
        run: |
          # ë°±ì—”ë“œì²˜ëŸ¼ gcloud ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸í•˜ê³  í‘¸ì‹œ
          gcloud auth print-access-token | \
            docker login -u oauth2accesstoken --password-stdin https://${{ env.GAR_LOCATION }}-docker.pkg.dev
          
          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:latest"

      # 9) Kubernetes ë°°í¬
      - name: ğŸš¢ Deploy to GKE
        run: |
          kubectl set image deployment/matcha-frontend matcha-frontend="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          kubectl apply -f k8s/frontend-service.yaml