# .github/workflows/gcp-frontend-deploy.yml
name: Deploy Frontend to GKE Autopilot

on:
  push:
    branches: ["main"]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: asia-northeast3
  GAR_REPO: matcha-repo
  IMAGE_NAME: matcha-frontend
  IMAGE_TAG: ${{ github.sha }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_LOCATION: ${{ secrets.GKE_LOCATION }}
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # WIF ì‚¬ìš©ì„ ìœ„í•œ í•„ìˆ˜ ê¶Œí•œ

    steps:

      # 1) Checkout
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2) Google Cloud ì¸ì¦ (WIF ì‚¬ìš©)
      - name: ğŸ”‘ Authenticate to Google Cloud (WIF)
        id: auth
        uses: google-github-actions/auth@v2
        with:
          # í”„ë¡œì íŠ¸ ë²ˆí˜¸: 348820882548, Service Account: github-actions-sa@matcha-480312.iam.gserviceaccount.com
          workload_identity_provider: projects/348820882548/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions-sa@matcha-480312.iam.gserviceaccount.com

      # 3) GKE ì¸ì¦ ì •ë³´ ì„¤ì • (ê°„ì†Œí™”: get-gke-credentials ì‚¬ìš©)
      - name: â˜¸ï¸ Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_LOCATION }}
          project_id: ${{ env.PROJECT_ID }}

      # 4) ë°±ì—”ë“œ ì„œë¹„ìŠ¤ IP ì£¼ì†Œ ì¡°íšŒ (ë™ì  í™˜ê²½ ë³€ìˆ˜ ì£¼ì…ì„ ìœ„í•œ ë¡œì§)
      - name: ğŸ” Get Backend Service External IP
        run: |
          BACKEND_IP=$(kubectl get svc matcha-backend-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -z "$BACKEND_IP" ]; then
            echo "âŒ ERROR: Backend Service IP not found. Is the backend service fully deployed?"
            exit 1
          fi
          echo "BACKEND_IP=$BACKEND_IP" >> $GITHUB_ENV
          
      # 5) Frontend Build (npm)
      - name: Build Frontend (npm ci / run build)
        run: |
          cd Matcha/frontend
          npm ci
          npm run build
      
      # 6) Docker Build & Tag (âœ… Docker Build êµ¬ë¬¸ ì˜¤ë¥˜ ìˆ˜ì •)
      - name: ğŸ—ï¸ Docker Build and Tag
        run: |
          # ë™ì ìœ¼ë¡œ ì¡°íšŒí•œ IPë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì‚¬ìš©í•˜ì—¬ URLì„ êµ¬ì„±
          API_URL="http://${{ env.BACKEND_IP }}"
          IMG_URL="http://${{ env.BACKEND_IP }}/uploads"
          
          docker build -f Matcha/frontend/Dockerfile \
          --build-arg VITE_API_BASE_URL=$API_URL \
          --build-arg VITE_IMG_BASE_URL=$IMG_URL \
          -t "${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:${IMAGE_TAG}" \
          -t "${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:latest" \
          Matcha/frontend # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë§ˆì§€ë§‰ì— ëª…í™•í•˜ê²Œ ì§€ì •

      # 7) Artifact Registry ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ Push
      - name: ğŸ”’ Docker Login to GAR
        uses: docker/login-action@v3
        with:
          registry: ${{ GAR_LOCATION }}-docker.pkg.dev
          username: _json_key
          password: ${{ steps.auth.outputs.access_token }}

      - name: ğŸ“¤ Push Images
        run: |
          docker push "${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:${IMAGE_TAG}"
          docker push "${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:latest"

      # 8) Kubernetes ë°°í¬ ë° ë¡¤ë§ ì—…ë°ì´íŠ¸
      - name: ğŸš¢ Apply K8s manifest and Restart
        run: |
          
          kubectl set image deployment/matcha-frontend matcha-frontend="${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:${IMAGE_TAG}"

        
          kubectl apply -f k8s/frontend-service.yaml