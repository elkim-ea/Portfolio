name: Deploy Frontend to GKE Autopilot

on:
  push:
    branches: ["main"]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: asia-northeast3
  GAR_REPO: matcha-repo
  IMAGE_NAME: matcha-frontend
  IMAGE_TAG: ${{ github.sha }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_LOCATION: ${{ secrets.GKE_LOCATION }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Install GKE Auth Plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-transport-https ca-certificates gnupg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" \
            | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg \
            | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          sudo apt-get update
          sudo apt-get install -y google-cloud-cli-gke-gcloud-auth-plugin

      - name: Add GKE Auth Plugin to PATH
        run: |
          SDK_ROOT=$(gcloud info --format='value(installation.sdk_root)')
          echo "SDK_ROOT = $SDK_ROOT"
          PLUGIN_PATH=$(find $SDK_ROOT -name gke-gcloud-auth-plugin | head -n 1)
          echo "$(dirname $PLUGIN_PATH)" >> $GITHUB_PATH

      - name: Verify plugin
        run: |
          which gke-gcloud-auth-plugin || echo "Plugin not in PATH"
          gke-gcloud-auth-plugin --version || echo "Plugin missing"

      - name: Enable GKE Auth Plugin Env
        run: echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Authenticate to GKE
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER \
            --region $GKE_LOCATION \
            --project $PROJECT_ID

      - name: Build Frontend
        run: |
          cd Matcha/frontend
          npm ci
          npm run build

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Build
        run: |
          docker buildx build \
            -f Matcha/frontend/Dockerfile \
            --build-arg VITE_API_BASE_URL=${{ secrets.API_BASE_URL }} \
            --build-arg VITE_IMG_BASE_URL=${{ secrets.IMG_BASE_URL }} \
            -t "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$GAR_REPO/$IMAGE_NAME:${IMAGE_TAG}" \
            -t "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$GAR_REPO/$IMAGE_NAME:latest" \
            --load \
            Matcha/frontend

      - name: Docker login to GAR
        run: |
          gcloud auth print-access-token \
            | docker login -u oauth2accesstoken --password-stdin https://$GAR_LOCATION-docker.pkg.dev

      - name: Push Docker Image
        run: |
          docker push "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$GAR_REPO/$IMAGE_NAME:${IMAGE_TAG}"
          docker push "$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$GAR_REPO/$IMAGE_NAME:latest"

      - name: Apply K8s manifest
        run: |
          kubectl apply -f k8s/frontend-deployment.yaml
          kubectl apply -f k8s/frontend-service.yaml

      - name: Restart frontend deployment
        run: kubectl rollout restart deployment/matcha-frontend
