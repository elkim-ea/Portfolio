# .github/workflows/gcp-frontend-deploy.yml
name: Deploy Frontend to GKE Autopilot

on:
  push:
    branches: ["main"]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: asia-northeast3 # <--- ÌôòÍ≤Ω Î≥ÄÏàòÎ°ú Ï†ïÏùòÎê®
  GAR_REPO: matcha-repo
  IMAGE_NAME: matcha-frontend
  IMAGE_TAG: ${{ github.sha }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_LOCATION: ${{ secrets.GKE_LOCATION }}
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # WIF Ïù∏Ï¶ù ÌïÑÏàò

    steps:

      # 1) Checkout
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2) Google Cloud Ïù∏Ï¶ù (WIF ÏÇ¨Ïö©)
      - name: üîë Authenticate to Google Cloud (WIF)
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/348820882548/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions-sa@matcha-480312.iam.gserviceaccount.com

      # 3) GKE Ïù∏Ï¶ù Ï†ïÎ≥¥ ÏÑ§Ï†ï
      - name: ‚ò∏Ô∏è Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_LOCATION }}
          project_id: ${{ env.PROJECT_ID }}

      # 4) Î∞±ÏóîÎìú ÏÑúÎπÑÏä§ IP Ï£ºÏÜå Ï°∞Ìöå
      - name: üîé Get Backend Service External IP
        run: |
          BACKEND_IP=$(kubectl get svc matcha-backend-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -z "$BACKEND_IP" ]; then
            echo "‚ùå ERROR: Backend Service IP not found."
            exit 1
          fi
          echo "BACKEND_IP=$BACKEND_IP" >> $GITHUB_ENV
          
      # 5) Frontend Build (npm)
      - name: Build Frontend (npm ci / run build)
        run: |
          cd Matcha/frontend
          npm ci
          npm run build
      
      # 6) Docker Build & Tag
      - name: üèóÔ∏è Docker Build and Tag
        run: |
          API_URL="http://${{ env.BACKEND_IP }}"
          IMG_URL="http://${{ env.BACKEND_IP }}/uploads"
          
          docker build -f Matcha/frontend/Dockerfile \
          --build-arg VITE_API_BASE_URL=$API_URL \
          --build-arg VITE_IMG_BASE_URL=$IMG_URL \
          -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:latest" \
          Matcha/frontend

      # 7) Artifact Registry Î°úÍ∑∏Ïù∏ Î∞è Ïù¥ÎØ∏ÏßÄ Push
      - name: üîí Docker Login to GAR (‚úÖ with Î∏îÎ°ù Î≥ÄÏàò Ï∞∏Ï°∞ ÏàòÏ†ï)
        uses: docker/login-action@v3
        with:
          # ‚úÖ env.GAR_LOCATIONÏúºÎ°ú ÏàòÏ†ïÌïòÏó¨ Íµ¨Î¨∏ Ïò§Î•ò Ìï¥Í≤∞
          registry: ${{ env.GAR_LOCATION }}-docker.pkg.dev 
          username: _json_key
          password: ${{ steps.auth.outputs.access_token }}

      - name: üì§ Push Images
        run: |
          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:latest"

      # 8) Kubernetes Î∞∞Ìè¨
      - name: üö¢ Apply K8s manifest
        run: |
          kubectl set image deployment/matcha-frontend matcha-frontend="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          kubectl apply -f k8s/frontend-service.yaml